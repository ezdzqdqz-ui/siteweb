<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTM — Connexion</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="login-page">

    <div class="login-container">
        <div class="login-brand">
            <div class="login-logo"><img src="images/logosite.png" alt="TTM"></div>
            <p>Trouve Ton Mate</p>
        </div>

        <div class="login-card">
            <!-- Discord OAuth (principal) -->
            <div class="discord-login-section" id="discordLoginSection">
                <a href="/auth/discord" class="btn-discord-login" id="discordLoginBtn">
                    <i class="fab fa-discord"></i>
                    Se connecter avec Discord
                </a>
                <div class="login-divider">
                    <span>ou</span>
                </div>
            </div>

            <div class="login-tabs">
                <button class="login-tab active" data-tab="login">Connexion locale</button>
                <button class="login-tab" data-tab="register">Inscription</button>
            </div>

            <div class="login-error" id="loginError" style="display:none">
                <i class="fas fa-exclamation-circle"></i>
                <span id="loginErrorText"></span>
            </div>

            <div class="login-success" id="loginSuccess" style="display:none">
                <i class="fas fa-check-circle"></i>
                <span id="loginSuccessText"></span>
            </div>

            <!-- LOGIN FORM -->
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label>Pseudo</label>
                    <div class="input-icon-wrap">
                        <i class="fas fa-user"></i>
                        <input type="text" class="form-input" id="login-username" placeholder="Ton pseudo" required autocomplete="username">
                    </div>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <div class="input-icon-wrap">
                        <i class="fas fa-lock"></i>
                        <input type="password" class="form-input" id="login-password" placeholder="Ton mot de passe" required autocomplete="current-password">
                    </div>
                </div>
                <label class="checkbox-label remember-me">
                    <input type="checkbox" id="login-remember" checked>
                    <span>Se souvenir de moi</span>
                </label>
                <button type="submit" class="btn btn-primary btn-lg login-submit">
                    <i class="fas fa-sign-in-alt"></i> Se connecter
                </button>
            </form>

            <!-- REGISTER FORM -->
            <form class="login-form" id="registerForm" style="display:none">
                <div class="form-group">
                    <label>Pseudo</label>
                    <div class="input-icon-wrap">
                        <i class="fas fa-user"></i>
                        <input type="text" class="form-input" id="reg-username" placeholder="Choisis ton pseudo" required minlength="3" maxlength="20" autocomplete="username">
                    </div>
                    <span class="form-hint">3 à 20 caractères — ce sera aussi ton pseudo affiché</span>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <div class="input-icon-wrap">
                        <i class="fas fa-lock"></i>
                        <input type="password" class="form-input" id="reg-password" placeholder="Min. 4 caractères" required minlength="4" autocomplete="new-password">
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirmer le mot de passe</label>
                    <div class="input-icon-wrap">
                        <i class="fas fa-lock"></i>
                        <input type="password" class="form-input" id="reg-confirm" placeholder="Retape ton mot de passe" required autocomplete="new-password">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-lg login-submit">
                    <i class="fas fa-user-plus"></i> Créer mon compte
                </button>
            </form>
        </div>

        <p class="login-footer"><i class="fas fa-shield-alt"></i> Tes données sont sauvegardées localement dans ton navigateur.</p>
    </div>

    <script src="js/data.js"></script>
    <script src="js/auth-bridge.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Check if server-side Discord auth is active
        try {
            const statusRes = await fetch('/api/status');
            const status = await statusRes.json();
            if (status.auth) {
                // Already logged in via Discord → go home
                location.href = 'index.html';
                return;
            }
            if (!status.discord) {
                // Discord OAuth not configured → hide the Discord button
                const dSection = document.getElementById('discordLoginSection');
                if (dSection) dSection.style.display = 'none';
            }
        } catch (e) {
            // Server not running → hide Discord button, use local auth only
            const dSection = document.getElementById('discordLoginSection');
            if (dSection) dSection.style.display = 'none';
        }

        // Check URL for OAuth errors
        const params = new URLSearchParams(location.search);
        if (params.get('error') === 'auth_failed') {
            showError('Échec de la connexion Discord. Réessaye.');
        }

        // Already logged in locally → go home
        if (TTM.Auth.isLoggedIn()) {
            location.href = 'index.html';
            return;
        }

        // Tab switching
        document.querySelectorAll('.login-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const isLogin = tab.dataset.tab === 'login';
                document.getElementById('loginForm').style.display = isLogin ? 'flex' : 'none';
                document.getElementById('registerForm').style.display = isLogin ? 'none' : 'flex';
                hideError();
                hideSuccess();
            });
        });

        function showError(msg) {
            hideSuccess();
            const el = document.getElementById('loginError');
            document.getElementById('loginErrorText').textContent = msg;
            el.style.display = 'flex';
            el.classList.remove('shake');
            void el.offsetWidth;
            el.classList.add('shake');
        }

        function hideError() {
            document.getElementById('loginError').style.display = 'none';
        }

        function showSuccess(msg) {
            hideError();
            document.getElementById('loginSuccessText').textContent = msg;
            document.getElementById('loginSuccess').style.display = 'flex';
        }

        function hideSuccess() {
            document.getElementById('loginSuccess').style.display = 'none';
        }

        // LOGIN
        document.getElementById('loginForm').addEventListener('submit', e => {
            e.preventDefault();
            hideError();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const remember = document.getElementById('login-remember').checked;

            if (!username || !password) { showError('Remplis tous les champs'); return; }

            const result = TTM.Auth.login(username, password, remember);
            if (result.ok) {
                showSuccess('Connexion réussie ! Redirection...');
                setTimeout(() => { location.href = 'index.html'; }, 600);
            } else {
                showError(result.error);
            }
        });

        // REGISTER
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError();
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm').value;

            if (!username || !password || !confirm) { showError('Remplis tous les champs'); return; }
            if (password !== confirm) { showError('Les mots de passe ne correspondent pas'); return; }

            const result = TTM.Auth.register(username, password);
            if (result.ok) {
                // Sync registration to server
                try { await TTM.initServerSync(); } catch(e) {}
                await TTM._syncRegisterToServer(result.userId, username, password);
                // Sync the default profile too
                await TTM._syncProfileToServer();
                showSuccess('Compte créé ! Configuration du profil...');
                setTimeout(() => { location.href = 'settings.html'; }, 800);
            } else {
                showError(result.error);
            }
        });

        // Auto-focus
        document.getElementById('login-username').focus();
    });
    </script>
</body>
</html>
